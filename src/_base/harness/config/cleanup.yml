function('built_images', [services]): |
  #!php
  $builtImages = [];

  foreach ($services as $service) {
    if ($service['image'] && count($service['upstream']) > 0) {
      $builtImages[] = $service['image'];
    }
  }

  # workspace commands don't allow non-string types
  = join(' ', $builtImages);

command('cleanup built-images'):
  env:
    BUILD_LABEL: = @('workspace.name') ~ ':' ~ @('app.version')
    IMAGES: = built_images(docker_service_images())
  exec: |
    #!bash
    IMAGES=($IMAGES)
    if [ "${#IMAGES[@]}" -gt 0 ]; then
      run docker image rm --force -- "${IMAGES[@]}"
    fi
    XARGS_OPTIONS=""
    if xargs --help 2>&1 | grep -q no-run-if-empty; then
      XARGS_OPTIONS=" --no-run-if-empty"
    fi
    run "docker images --filter=label=build=$(printf '%q' "$BUILD_LABEL") -q | xargs${XARGS_OPTIONS} docker image rm --force"
