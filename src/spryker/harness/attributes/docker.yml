attributes:
  services:
    php-base:
      environment:
        APPLICATION_ENV: = @('spryker.mode')
        REDIS_PROTOCOL: = @('redis.protocol')
        SMTP_HOST: = @('smtp.host')
        SMTP_PORT: = @('smtp.port')
        HAS_JENKINS_RUNNER: "= ('jenkins-runner' in @('app.services') ? 'true' : 'false')"
        JENKINS_HOST: = @('jenkins.host')
        JENKINS_PORT: = @('jenkins.port')
        JENKINS_URL: = 'http://' ~ @('jenkins.host') ~ ':' ~ @('jenkins.port') ~ '/'
        JENKINS_EXTERNAL_HOST: = @('jenkins.external_host')
      environment_secrets:
        SPRYKER_SALT: = @('spryker.salt')
    jenkins:
      enabled: "= 'jenkins' in @('app.services')"
      image: jenkins/jenkins:2.263.1-lts-alpine
      resources:
        memory: "1536Mi"
    jenkins-runner:
      enabled: "= 'jenkins-runner' in @('app.services')"
      image: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-jenkins-runner'
      publish: "= 'jenkins-runner' in @('app.services')"
      environment:
        RUNNER_NUM_EXECUTORS: 1
    rabbitmq:
      environment:
        RABBITMQ_DEFAULT_USER: spryker
      environment_secrets:
        RABBITMQ_DEFAULT_PASS: spryker

  pipeline:
    base:
      services:
        php-base:
          JENKINS_HOST: = '{{ .Values.resourcePrefix  }}' ~ @('jenkins.host')
    preview:
      services:
        php-base:
          environment:
            JENKINS_EXTERNAL_HOST: = @('pipeline.preview.jenkins.external_host')
            SMTP_HOST: = @('pipeline.preview.smtp.host')
            DOCKER_IMAGE_CONSOLE: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-console'
            DOCKER_IMAGE_FPM: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-php-fpm'
            DOCKER_IMAGE_NGINX: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-nginx'
            DOCKER_IMAGE_JENKINS_RUNNER: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-jenkins-runner'
      persistence:
        enabled: true
        spryker:
          data:
            storageClass: nfs
    qa:
      services:
        php-base:
          environment:
            JENKINS_EXTERNAL_HOST: = @('pipeline.qa.jenkins.external_host')
            SMTP_HOST: = @('pipeline.qa.smtp.host')
