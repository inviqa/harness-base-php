attributes:
  services:
    php-base:
      environment:
        APPLICATION_ENV: = @('spryker.mode')
        REDIS_PROTOCOL: = @('redis.protocol')
        HAS_JENKINS_RUNNER: "= @('services.jenkins-runner.enabled') ? 'true' : 'false'"
        JENKINS_HOST: = @('jenkins.host')
        JENKINS_PORT: = @('jenkins.port')
        JENKINS_URL: = 'http://' ~ @('jenkins.host') ~ ':' ~ @('jenkins.port') ~ '/'
        JENKINS_EXTERNAL_HOST: = @('jenkins.external_host')
      environment_secrets:
        SPRYKER_SALT: = @('spryker.salt')
        SPRYKER_OAUTH_CLIENT_IDENTIFIER: "frontend"
        # not required for development env, must be set for remote (recommended size: 48)
        SPRYKER_OAUTH_CLIENT_SECRET: = @('spryker.oauth_client_secret')
        # not required for development env, must be set for remote (recommended size: 80)
        SPRYKER_ZED_REQUEST_TOKEN: = @('spryker.zed_request_token')
    jenkins:
      enabled: "= 'jenkins' in @('app.services')"
      image: jenkins:alpine
    jenkins-runner:
      enabled: "= 'jenkins-runner' in @('app.services')"
      image: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-jenkins-runner'
      publish: = @('services.jenkins-runner.enabled')
      environment:
        RUNNER_NUM_EXECUTORS: 1
    rabbitmq:
      environment:
        RABBITMQ_DEFAULT_USER: spryker
      environment_secrets:
        RABBITMQ_DEFAULT_PASS: spryker
    redis:
      image: redis:5-alpine

  pipeline:
    base:
      services:
        php-base:
          environment:
            JENKINS_HOST: = '{{ .Values.resourcePrefix  }}' ~ @('jenkins.host')
            JENKINS_URL: = 'http://{{ .Values.resourcePrefix  }}' ~ @('jenkins.host') ~ ':' ~ @('jenkins.port') ~ '/'
    preview:
      services:
        php-base:
          environment:
            JENKINS_EXTERNAL_HOST: = @('pipeline.preview.jenkins.external_host')
            DOCKER_IMAGE_CONSOLE: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-console'
            DOCKER_IMAGE_FPM: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-php-fpm'
            DOCKER_IMAGE_NGINX: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-nginx'
            DOCKER_IMAGE_JENKINS_RUNNER: = @('docker.repository') ~ ':' ~ @('app.version') ~ '-jenkins-runner'
      persistence:
        enabled: true
        spryker:
          data:
            storageClass: nfs
    qa:
      services:
        php-base:
          environment:
            JENKINS_EXTERNAL_HOST: = @('pipeline.qa.jenkins.external_host')
